<ng-template #searchbox>
  <nz-row [nzGutter]="12">
    <nz-col>
      <nz-input-group nzCompact>
        <input
          (keyup.enter)="submitSearch()"
          [(ngModel)]="coll.searchText"
          style="width: 420px"
          type="text"
          nz-input
          placeholder="请输入关键词（ 多个关键词使用逗号分隔 ）"
        />
        <button (click)="submitSearch()" nz-button nzSearch><i nz-icon nzType="search"></i></button>
      </nz-input-group>
    </nz-col>
    <nz-col>
      <nz-button-group>
        <button nz-button (click)="openSearchForm()"> 高级搜索 </button>
        <button nz-button nzType="dashed" nz-tooltip="清除搜索" (click)="clearSearch()">
          <i nz-icon nzType="clear"></i>
        </button>
      </nz-button-group>
    </nz-col>
  </nz-row>
  <nz-drawer
    nzTitle="高级搜索"
    [nzVisible]="searchVisible"
    [nzWidth]="450"
    [nzMask]="false"
    [nzFooter]="footerTpl"
    [nzBodyStyle]="{ overflow: 'auto' }"
    (nzOnClose)="closeSearchForm()"
  >
    <ng-container *nzDrawerContent>
      <form
        *ngIf="searchForm"
        id="search"
        nzLayout="vertical"
        nz-form
        [formGroup]="searchForm"
        (wpxSubmit)="submitSearch($event)"
      >
        <ng-container *ngFor="let x of coll.columns">
          <nz-form-item [formGroupName]="x.value" style="margin-bottom: 1em">
            <nz-form-label>{{ x.label }}</nz-form-label>
            <nz-form-control>
              <nz-input-group nzCompact>
                <nz-select style="width: 30%" formControlName="operator">
                  <nz-option [nzLabel]="'精确'" [nzValue]="'$eq'"></nz-option>
                  <nz-option [nzLabel]="'模糊'" [nzValue]="'$regex'"></nz-option>
                </nz-select>
                <input style="width: 70%" nz-input formControlName="value" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </ng-container>
      </form>
    </ng-container>

    <ng-template #footerTpl>
      <nz-space>
        <button *nzSpaceItem nz-button form="search"> <i nz-icon nzType="search"></i> 搜索 </button>
        <button *nzSpaceItem nz-button (click)="resetSearch()" type="reset">
          <i nz-icon nzType="clear"></i> 重置
        </button>
      </nz-space>
    </ng-template>
  </nz-drawer>
</ng-template>

<ng-template #toolbox>
  <nz-button-group>
    <button nz-button nzType="text" nz-tooltip="刷新" (click)="fetch.emit(true)">
      <i nz-icon nzType="reload"></i>
    </button>
    <button
      nz-button
      nzType="text"
      nz-tooltip="密度"
      nz-popover
      nzPopoverPlacement="bottomRight"
      nzPopoverTrigger="click"
      [nzPopoverTitle]="columnsSizeTitle"
      [nzPopoverContent]="columnsSizeContent"
    >
      <i nz-icon nzType="column-height"></i>
      <ng-template #columnsSizeTitle>
        <label nz-checkbox [(ngModel)]="customWidth" (ngModelChange)="onMessage()"> 自定义宽度 </label>
      </ng-template>
      <ng-template #columnsSizeContent>
        <nz-radio-group [(ngModel)]="coll.columnsHeight" (ngModelChange)="coll.updateStorage()">
          <label nz-radio-button nzValue="default">默认</label>
          <label nz-radio-button nzValue="middle">中等</label>
          <label nz-radio-button nzValue="small">紧凑</label>
        </nz-radio-group>
      </ng-template>
    </button>
    <button
      nz-button
      nzType="text"
      nz-tooltip="列设置"
      nz-popover
      nzPopoverPlacement="bottomRight"
      nzPopoverTrigger="click"
      [nzPopoverTitle]="columnsTitle"
      [nzPopoverContent]="columnsContent"
    >
      <i nz-icon nzType="setting"></i>
      <ng-template #columnsTitle>
        <nz-row nzJustify="space-between">
          <nz-col>
            <label
              nz-checkbox
              [(ngModel)]="coll.columnsChecked"
              (ngModelChange)="coll.updateColumnsChecked()"
              [nzIndeterminate]="coll.columnsIndeterminate"
            >
              全部展示
            </label>
          </nz-col>
          <nz-col></nz-col>
          <nz-col>
            <button nzSize="small" nz-button nzType="text" (click)="coll.columnsReset()">重置</button>
          </nz-col>
        </nz-row>
      </ng-template>
      <ng-template #columnsContent>
        <nz-checkbox-group [(ngModel)]="coll.columns" (ngModelChange)="coll.updateColumnChecked()"></nz-checkbox-group>
      </ng-template>
    </button>
  </nz-button-group>
</ng-template>

<nz-table
  #basicTable
  [nzTitle]="coll.checkedNumber ? bulk : null"
  [nzLoading]="coll.loading"
  [nzLoadingDelay]="200"
  [nzSize]="coll.columnsHeight"
  [nzData]="coll.value"
  [nzScroll]="scroll"
  [nzFrontPagination]="false"
  [nzShowSizeChanger]="true"
  [nzTotal]="coll.total"
  [(nzPageSize)]="coll.pageSize"
  [(nzPageIndex)]="coll.pageIndex"
  (nzPageIndexChange)="fetch.emit(false)"
  (nzPageSizeChange)="fetch.emit(true)"
>
  <ng-template #bulk>
    <nz-alert nzType="info" nzBanner [nzMessage]="message"></nz-alert>
    <ng-template #message>
      <nz-row nzJustify="space-between">
        <nz-col> 已选中 {{ coll.checkedNumber }} 项 </nz-col>
        <nz-col></nz-col>
        <nz-col style="text-align: right">
          <a nz-button nzType="link" nzSize="small">操作<i nz-icon nzType="down"></i></a>
          <a nz-button nzType="link" nzSize="small" (click)="coll.clearChecked()">取消选择</a>
        </nz-col>
      </nz-row>
    </ng-template>
  </ng-template>
  <thead>
    <tr>
      <th
        nzWidth="65px"
        nzLeft
        nzAlign="center"
        [nzChecked]="coll.checked"
        [nzIndeterminate]="coll.indeterminate"
        (nzCheckedChange)="coll.setNChecked($event)"
      ></th>
      <ng-container *ngFor="let x of coll.displayColumns">
        <th
          nz-resizable
          nzBounds="window"
          [nzDisabled]="!customWidth"
          [nzPreview]="customWidth"
          [nzMaxWidth]="420"
          [nzMinWidth]="100"
          (nzResizeEnd)="resize($event, x.value)"
          [nzWidth]="coll.columnsWidth[x.value] ?? '300px'"
          [nzShowSort]="!customWidth"
          [(nzSortOrder)]="coll.sortOptions[x.value]"
          (nzSortOrderChange)="fetch.emit(true)"
        >
          {{ x.label }}
          <ng-container *ngIf="keywords.has(x.value)">
            <i nz-icon nzType="tag" nz-tooltip="关键词"></i>
          </ng-container>

          <nz-resize-handle nzDirection="right" *ngIf="customWidth">
            <div class="resize-trigger"></div>
          </nz-resize-handle>
        </th>
      </ng-container>
      <th nzWidth="100px" nzRight nzAlign="center">操作</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let data of basicTable.data">
      <td
        nzLeft
        nzAlign="center"
        [nzDisabled]="data.disabled"
        [nzChecked]="coll.checkedIds.has(data._id)"
        (nzCheckedChange)="coll.setChecked(data._id, $event)"
      ></td>
      <ng-container *ngFor="let x of coll.displayColumns">
        <td>
          <p style="margin: 0" nz-typography nzEllipsis [nzEllipsisRows]="2">
            {{ data[x.value] }}
          </p>
        </td>
      </ng-container>
      <td nzRight nzAlign="center">
        <button nz-button nzType="text">
          <i nz-icon nzType="ellipsis"></i>
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>
