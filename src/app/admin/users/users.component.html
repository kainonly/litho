<ng-template #titleRef>
  <nz-space nzAlign="center">
    <wpx-keyword
      *nzSpaceItem
      [wpxModel]="model"
      [wpxKeys]="['email', 'name']"
      (wpxSubmit)="getData()"
      wpxPlaceholder="电子邮件、姓名"
    ></wpx-keyword>
    <wpx-toolbox *nzSpaceItem [wpxModel]="model" [wpxSearchForm]="form" (wpxClear)="clear()" (wpxRefresh)="getData()">
      <form *ngIf="form" nz-form id="search" [formGroup]="form" (wpxSubmit)="search($event)">
        <nz-row [nzGutter]="[16, 16]">
          <nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label>电子邮件</nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="email" />
              </nz-form-control>
            </nz-form-item>
          </nz-col>
          <nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label>姓名</nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="name" />
              </nz-form-control>
            </nz-form-item>
          </nz-col>
        </nz-row>
      </form>
    </wpx-toolbox>
  </nz-space>
</ng-template>

<ng-template #extraRef>
  <nz-space nzAlign="center">
    <ng-container *ngIf="model.selection.size as size">
      <button *nzSpaceItem nz-button nzType="dashed" nz-dropdown [nzDropdownMenu]="menu"> 已选中 {{ size }} 项 </button>
      <nz-dropdown-menu #menu="nzDropdownMenu">
        <ul nz-menu>
          <li nz-menu-item (click)="basicTable.clearSelections()"> 取消选择 </li>
        </ul>
        <ul nz-menu>
          <li nz-menu-item nzDanger (click)="bulkDelete()"> 删除 </li>
        </ul>
      </nz-dropdown-menu>
    </ng-container>
    <button *nzSpaceItem nz-button nzType="primary" (click)="open()"> 新增 </button>
  </nz-space>
</ng-template>

<wpx-table
  #basicTable
  [wpxTitle]="titleRef"
  [wpxExtra]="extraRef"
  [wpxModel]="model"
  [wpxColumns]="[
    {
      title: '电子邮件',
      width: '320px',
      render: username
    },
    {
      title: '姓名',
      key: 'name',
      width: '160px'
    },
    {
      title: '状态',
      key: 'status',
      width: '120px',
      format: 'status'
    },
    {
      title: '近期登录 (会话数)',
      width: '240px',
      render: history
    },
    {
      title: '加入时间',
      key: 'create_time',
      width: '240px',
      format: 'date'
    }
  ]"
  [wpxItemSize]="50"
  [wpxOffset]="310"
  [wpxActions]="actions"
  (wpxChange)="getData()"
>
  <ng-template #username let-data>
    <nz-space>
      <span *nzSpaceItem>{{ data.email }}</span>
      <ng-container *ngIf="data.lark && data.lark === '*'">
        <span *nzSpaceItem nz-icon nzType="idcard" nzTheme="twotone" nz-tooltip="已绑定飞书"></span>
      </ng-container>
      <ng-container *ngIf="data.phone && data.phone === '*'">
        <span *nzSpaceItem nz-icon nzType="phone" nzTheme="twotone" nz-tooltip="已绑定手机"></span>
      </ng-container>
      <ng-container *ngIf="data.totp && data.totp === '*'">
        <span *nzSpaceItem nz-icon nzType="safety-certificate" nzTheme="twotone" nz-tooltip="已绑定TOTP"></span>
      </ng-container>
    </nz-space>
  </ng-template>
  <ng-template #history let-data>
    {{ data.history.timestamp | date: 'yyyy-MM-dd HH:mm:ss' }} （{{ data.sessions }}）
  </ng-template>
</wpx-table>

<nz-dropdown-menu #actions="nzDropdownMenu">
  <ul *ngIf="basicTable.actived as v" nz-menu>
    <li nz-menu-item nzDisabled>
      <b>电子邮件 [{{ v.email }}]</b>
    </li>
    <li nz-menu-divider></li>
    <li nz-menu-item (click)="open(v)"> 修改 </li>
    <li nz-menu-item nzDanger (click)="delete(v)"> 删除 </li>
  </ul>
</nz-dropdown-menu>
