<nz-space>
  <nz-input-group *nzSpaceItem [nzPrefix]="suffixIconSearch" style="width: 180px">
    <input type="text" nz-input placeholder="搜索" [(ngModel)]="searchText" />
    <ng-template #suffixIconSearch>
      <span nz-icon nzType="search"></span>
    </ng-template>
  </nz-input-group>
  <nz-button-group *nzSpaceItem>
    <button nz-button nzType="text" nz-tooltip="刷新" (click)="getData()">
      <i nz-icon nzType="reload"></i>
    </button>
    <button nz-button nzType="text" [nz-tooltip]="expand ? '收起' : '展开'" (click)="expanded()">
      <span nz-icon [nzType]="expand ? 'node-collapse' : 'node-expand'"></span>
    </button>
    <button nz-button nzType="text" nz-tooltip="新增" (click)="form()">
      <span nz-icon nzType="sisternode"></span>
    </button>
  </nz-button-group>
</nz-space>

<nz-divider style="margin: 8px 0"></nz-divider>

<nz-tree
  #tree
  nzBlockNode
  nzExpandAll
  nzShowLine
  nzDraggable
  [nzData]="nodes"
  [nzSearchValue]="searchText"
  [nzExpandedIcon]="nzExpandedIcon"
  [nzTreeTemplate]="nzTreeTemplate"
  [nzSelectedKeys]="selectedKeys"
  (nzClick)="selected($event)"
  (nzContextMenu)="actions($event, treeActions)"
  (nzOnDrop)="reorganization($event)"
>
  <ng-template #nzExpandedIcon let-node>
    <span class="custom-icon" *ngIf="factory.dict?.[node.key] as page">
      <ng-container *ngIf="!page.status; else kindTpl">
        <i nz-icon nzType="stop" nzTheme="twotone" [nzTwotoneColor]="'#ff7875'"></i>
      </ng-container>
      <ng-template #kindTpl [ngSwitch]="page.kind">
        <ng-container *ngSwitchCase="'default'">
          <i nz-icon nzType="database" nzTheme="twotone"></i>
        </ng-container>
        <ng-container *ngSwitchCase="'aggregation'">
          <i nz-icon nzType="calculator" nzTheme="twotone"></i>
        </ng-container>
        <ng-container *ngSwitchCase="'manual'">
          <i nz-icon nzType="code" nzTheme="twotone"></i>
        </ng-container>
        <ng-container *ngSwitchCase="'group'">
          <i nz-icon [nzType]="!node.isExpanded ? 'folder' : 'folder-open'" nzTheme="twotone"></i>
        </ng-container>
      </ng-template>
    </span>
  </ng-template>

  <ng-template #nzTreeTemplate let-node>
    <span class="custom-node" *ngIf="factory.dict?.[node.key] as page">
      <i *ngIf="page.icon" nz-icon [nzType]="page.icon"></i>
      <span>
        {{ page.name }}
        <ng-container *ngIf="page.manifest">
          [
          <ng-container [ngSwitch]="page.manifest">
            <ng-container *ngSwitchCase="'default'"> 标准表格 </ng-container>
            <ng-container *ngSwitchCase="'form'">独立表单</ng-container>
            <ng-container *ngSwitchCase="'dashboard'">仪表盘</ng-container>
          </ng-container>
          ]
        </ng-container>
        <ng-container *ngIf="page.manual"> [{{ page.manual.scope }}] </ng-container>
      </span>
    </span>
  </ng-template>
  <!-- 右键操作 -->
  <nz-dropdown-menu #treeActions="nzDropdownMenu">
    <ul *ngIf="actionId" nz-menu>
      <ng-container *ngIf="factory.dict?.[actionId] as page">
        <li nz-menu-item [nzSelected]="false">
          <i *ngIf="page.icon" nz-icon [nzType]="page.icon"></i>&nbsp;
          <span>{{ page.name }}</span>
        </li>
        <li nz-menu-divider></li>
        <ng-container *ngIf="page.kind === 'group'">
          <li nz-menu-item (click)="form(undefined, page._id)"> 新增 </li>
        </ng-container>
        <li nz-menu-item (click)="form(page)"> 编辑 </li>
        <li nz-menu-item nzDanger (click)="delete(page)"> 删除 </li>
      </ng-container>
    </ul>
  </nz-dropdown-menu>
</nz-tree>

<nz-drawer nzTitle="拖拽进行重组" [nzVisible]="reorganizationVisible" (nzOnClose)="closeReorganization()">
  <ng-container *nzDrawerContent>
    <nz-tree
      nzBlockNode
      nzExpandAll
      nzShowLine
      nzDraggable
      [nzData]="reorganizationNodes"
      (nzOnDrop)="reorganization($event)"
    >
    </nz-tree>
  </ng-container>
</nz-drawer>
