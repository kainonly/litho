<bit-header>
  <nz-alert
    bitBanner
    nzBanner
    nzType="info"
    nzCloseable
    [nzMessage]="bit.l['uploadTip']"
    (nzOnClose)="fetchInfiniteY()"
  ></nz-alert>
  <bit-transport [action]="transport" (actionComplete)="transportComplete()"></bit-transport>
</bit-header>

<ng-template #title>
  <nz-space>
    <nz-button-group *nzSpaceItem>
      <button nz-button (click)="checkedAllBind($event)">
        <label
          nz-checkbox
          [(ngModel)]="ds.lists.checked"
          [nzIndeterminate]="ds.lists.indeterminate"
          (ngModelChange)="ds.lists.checkedAll($event)"
        >
          {{ bit.l["checked"] }}
        </label>
      </button>
      <button
        nz-button
        nz-dropdown
        [nzDropdownMenu]="bulkActions"
        [nzTrigger]="'click'"
        [nzClickHide]="false"
        [disabled]="!ds.lists.batch"
      >
        <nz-badge [nzCount]="ds.lists.checkedNumber" [nzOffset]="[3, -12]">
          <i nz-icon nzType="ellipsis"></i>
        </nz-badge>
        <nz-dropdown-menu #bulkActions>
          <ul nz-menu>
            <li nz-menu-item (click)="openMoveModal(ds.lists.getChecked())">
              <i nz-icon nzType="swap"></i>
              {{ bit.l["move"] }}
            </li>
            <li nz-menu-item (click)="openDeleteModal(ds.lists.getChecked())">
              <i nz-icon nzType="delete"></i>
              {{ bit.l["deleteItem"] }}
            </li>
          </ul>
        </nz-dropdown-menu>
      </button>
    </nz-button-group>
    <ng-container *ngIf="ds.lists.hasSearch('type_id')">
      <nz-select
        *nzSpaceItem
        style="width: 240px"
        nzShowSearch
        [(ngModel)]="ds.lists.search['type_id'].value"
        [bitSearchChange]="ds.lists"
        (after)="ds.fetchData(true)"
        [nzDropdownRender]="renderTemplate"
        [nz-tooltip]="bit.l['typePlaceholder']"
      >
        <nz-option nzCustomContent [nzValue]="''" [nzLabel]="bit.l['all']">
          <span>{{ bit.l["all"] }}</span>
          <nz-badge
            *ngIf="typeCount.hasOwnProperty('total')"
            class="custom-badge"
            nzStandalone
            [nzCount]="typeCount['total']"
            [nzStyle]="typeCountStyle"
          ></nz-badge>
        </nz-option>
        <nz-option nzCustomContent [nzValue]="0" [nzLabel]="bit.l['unknownType']">
          <span>{{ bit.l["unknownType"] }}</span>
          <nz-badge
            *ngIf="typeCount.hasOwnProperty('0')"
            class="custom-badge"
            nzStandalone
            [nzCount]="typeCount['0']"
            [nzStyle]="typeCountStyle"
          ></nz-badge>
        </nz-option>
        <nz-option nzCustomContent *ngFor="let x of typeLists" [nzValue]="x.id" [nzLabel]="x.name">
          <span>{{ x.name }}</span>
          <nz-badge
            *ngIf="typeCount.hasOwnProperty(x.id)"
            class="custom-badge"
            nzStandalone
            [nzCount]="typeCount[x.id]"
            [nzStyle]="typeCountStyle"
          ></nz-badge>
        </nz-option>
      </nz-select>
      <ng-template #renderTemplate>
        <button nz-button nzType="link" nzBlock (click)="openTypeDrawer()">
          <i nz-icon nzType="form"></i>
          {{ bit.l["editType"] }}
        </button>
      </ng-template>
    </ng-container>
    <ng-container *ngIf="ds.lists.hasSearch('name')">
      <nz-input-group *nzSpaceItem nzSearch [nzAddOnAfter]="nzAddOnAfter" style="width: 320px">
        <input
          nz-input
          [bitSearchStart]="ds.lists"
          [placeholder]="bit.l['search']"
          [(ngModel)]="ds.lists.search['name'].value"
          (after)="ds.fetchData(true)"
        />
      </nz-input-group>
      <ng-template #nzAddOnAfter>
        <button
          nz-button
          nzType="primary"
          nzSearch
          [bitSearchStart]="ds.lists"
          (after)="ds.fetchData(true)"
        >
          <i nz-icon nzType="search"></i>
        </button>
      </ng-template>
    </ng-container>
    <button *nzSpaceItem nz-button nzType="default" (click)="ds.fetchData(true)">
      <i nz-icon nzType="sync"></i>
      {{ bit.l["refreshLists"] }}
    </button>
    <button *nzSpaceItem nz-button nzType="default" [bitSearchClear]="ds.lists" (after)="ds.fetchData(true)">
      <i nz-icon nzType="clear"></i>
      {{ bit.l["clearSearch"] }}
    </button>
  </nz-space>
</ng-template>

<nz-drawer
  [nzClosable]="false"
  [nzWidth]="640"
  [nzVisible]="typeVisible"
  [nzTitle]="typeTitle"
  [nzFooter]="typeSort ? typeFooter : null"
  (nzOnClose)="closeTypeDrawer()"
>
  <ng-template #typeFooter>
    <nz-alert nzType="info" nzBanner [nzMessage]="bit.l['typeSortTip']"></nz-alert>
  </ng-template>
  <ng-template #typeTitle>
    <nz-space>
      <ng-container *nzSpaceItem>
        {{ bit.l["editType"] }}
      </ng-container>
      <nz-switch
        *nzSpaceItem
        [(ngModel)]="typeSort"
        [nzCheckedChildren]="bit.l['sort']"
        [nzUnCheckedChildren]="bit.l['sort']"
      >
      </nz-switch>
    </nz-space>
  </ng-template>
  <ng-container *nzDrawerContent>
    <nz-table #typeTable [nzSize]="'middle'" [nzData]="typeLists" [(nzPageIndex)]="typePageIndex">
      <thead>
      <tr>
        <th nzWidth="70%">{{ bit.l["typeName"] }}</th>
        <th *ngIf="!typeSort">{{ bit.l["action"] }}</th>
      </tr>
      </thead>
      <tbody cdkDropList [cdkDropListDisabled]="!typeSort" (cdkDropListDropped)="drop($event)">
      <tr *ngIf="!typeSort">
        <td>
          <input
            nz-input
            [(ngModel)]="typeName"
            [placeholder]="bit.l['typeNamePlaceholder']"
            (keyup.enter)="addTypeSubmit()"
          />
        </td>
        <td>
          <a (click)="addTypeSubmit()"><i nz-icon nzType="check"></i> {{ bit.l["submit"] }}</a>
          <nz-divider nzType="vertical"></nz-divider>
          <a (click)="addTypeCancel()"><i nz-icon nzType="close"></i> {{ bit.l["cancel"] }}</a>
        </td>
      </tr>
      <tr
        *ngFor="let data of typeTable.data; index as i"
        [ngClass]="{ 'drag-cursor': typeSort }"
        cdkDrag
        (contextmenu)="openSortMenu($event, sortMenu)"
      >
        <ng-container *ngIf="editTypeCell(data); else normalCellTel">
          <td>
            <input
              nz-input
              [(ngModel)]="data.editName"
              [placeholder]="bit.l['typeNamePlaceholder']"
              (keyup.enter)="editTypeSubmit(data)"
            />
          </td>
          <td>
            <a (click)="editTypeSubmit(data)">
              <i nz-icon nzType="check"></i> {{ bit.l["submit"] }}
            </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="editTypeCancel()">
              <i nz-icon nzType="close"></i> {{ bit.l["cancel"] }}
            </a>
          </td>
        </ng-container>
        <ng-template #normalCellTel>
          <td>
            {{ data.name }}
          </td>
          <td *ngIf="!typeSort">
            <a (click)="editType(data)"> <i nz-icon nzType="edit"></i> {{ bit.l["edit"] }} </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a
              nz-popconfirm
              [nzPopconfirmTitle]="bit.l['deleteWarning']"
              (nzOnConfirm)="editTypeDelete([data.id])"
            >
              <i nz-icon nzType="delete"></i> {{ bit.l["delete"] }}
            </a>
          </td>
        </ng-template>
        <nz-dropdown-menu #sortMenu>
          <ul nz-menu>
            <li nz-menu-item (click)="sortMove(i, 0)">
              <i nz-icon nzType="vertical-align-top"></i> 排序置顶
            </li>
            <li nz-menu-item (click)="sortMove(i, i - typePageIndex * 10)">
              <i nz-icon nzType="vertical-right"></i> 向前一页
            </li>
            <li nz-menu-item (click)="sortMove(i, i + typePageIndex * 10)">
              <i nz-icon nzType="vertical-left"></i> 向后一页
            </li>
            <li nz-menu-item (click)="sortMove(i, typeLists.length - 1)">
              <i nz-icon nzType="vertical-align-bottom"></i> 排序置底
            </li>
          </ul>
        </nz-dropdown-menu>
      </tr>
      </tbody>
    </nz-table>
  </ng-container>
</nz-drawer>

<nz-ribbon [nzText]="bit.l['typeCount'] | Print: currentCount()">
  <nz-card [nzTitle]="title">
    <cdk-virtual-scroll-viewport
      class="infinite-container"
      [itemSize]="8"
      [ngStyle]="{ 'height.px': infiniteY$ | async }"
    >
      <nz-list nzGrid>
        <nz-list-empty *ngIf="ds.empty()"></nz-list-empty>
        <div nz-row [nzGutter]="8">
          <div nz-col *cdkVirtualFor="let x of ds">
            <nz-list-item *ngIf="x">
              <nz-card
                style="width: 195px"
                nzSize="small"
                [nzHoverable]="true"
                [nzCover]="coverTpl"
                [nzActions]="[actionCopy, actionRename, actionEllipsis]"
              >
                <ng-template #coverTpl>
                  <ng-container [ngSwitch]="key">
                    <ng-container *ngSwitchCase="'picture'">
                      <div
                        class="thumb"
                        [style]="{ 'background-image': thumb(x.url) }"
                        (click)="preview(x)"
                      >
                        <div class="thumb-actions">
                          <i nz-icon nzType="search"></i>
                        </div>
                      </div>
                    </ng-container>
                    <ng-container *ngSwitchCase="'video'">
                      <div class="video">
                        <video controls="controls">
                          <source [src]="bit.static + x.url" type="video/mp4" />
                        </video>
                      </div>
                    </ng-container>
                    <ng-container *ngSwitchCase="'audio'">
                      <div class="audio">
                        <audio controls="controls">
                          <source [src]="bit.static + x.url" type="audio/mpeg" />
                        </audio>
                      </div>
                    </ng-container>
                  </ng-container>
                </ng-template>
                <ng-template #actionCopy>
                  <i
                    nz-icon
                    nzType="link"
                    [nz-tooltip]="x.copied ? copyTip : bit.static + x.url"
                    [nzTooltipMouseEnterDelay]="0.2"
                    (click)="copy(x)"
                  ></i>
                  <ng-template #copyTip>
                  <span nz-typography nzType="success">
                    <i nz-icon nzType="check"></i>
                  </span>
                    {{ bit.l["copied"] }}
                  </ng-template>
                </ng-template>
                <ng-template #actionRename>
                  <i
                    nz-icon
                    nzType="edit"
                    [nz-tooltip]="bit.l['rename']"
                    [nzTooltipMouseEnterDelay]="0.2"
                    (click)="openRenameModal(x)"
                  ></i>
                </ng-template>
                <ng-template #actionEllipsis>
                  <i
                    nz-icon
                    nzType="ellipsis"
                    nz-dropdown
                    [nzDropdownMenu]="actionMenu"
                    [nzTrigger]="'click'"
                    [nzClickHide]="false"
                  ></i>
                  <nz-dropdown-menu #actionMenu>
                    <ul nz-menu>
                      <li nz-menu-item (click)="openMoveModal([x])">
                        <i nz-icon nzType="swap"></i>
                        {{ bit.l["move"] }}
                      </li>
                      <li nz-menu-item (click)="openDeleteModal([x])">
                        <i nz-icon nzType="delete"></i>
                        {{ bit.l["deleteItem"] }}
                      </li>
                    </ul>
                  </nz-dropdown-menu>
                </ng-template>

                <nz-card-meta [nzTitle]="cardTitle">
                  <ng-template #cardTitle>
                    <label
                      nz-checkbox
                      [(ngModel)]="x.checked"
                      (ngModelChange)="ds.lists.refreshStatus()"
                      [nz-tooltip]="x.name"
                      [nzTooltipMouseEnterDelay]="0.2"
                    >
                      {{ x.name }}
                    </label>
                  </ng-template>
                </nz-card-meta>
              </nz-card>
            </nz-list-item>
          </div>
        </div>
      </nz-list>
    </cdk-virtual-scroll-viewport>
  </nz-card>
</nz-ribbon>

<nz-modal
  #renameModal
  [nzTitle]="bit.l['confirm']"
  [nzOkDisabled]="!renameForm ? false : !renameForm.valid"
  (nzOnOk)="submitRename()"
  (nzOnCancel)="closeRenameModal()"
>
  <ng-container *nzModalContent>
    <form *ngIf="renameData" nz-form nzLayout="vertical" [formGroup]="renameForm">
      <nz-form-item>
        <nz-form-label nzRequired>
          <span [innerHTML]="bit.l['renameLabel'] | Print: [renameData.name]"></span>
        </nz-form-label>
        <nz-form-control [nzErrorTip]="name.ref">
          <input formControlName="name" nz-input [placeholder]="bit.l['namePlaceholder']" />
          <bit-error-tip
            #name
            [hasError]="{
              required: bit.l['nameRequire']
            }"
          ></bit-error-tip>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<nz-modal
  #moveModal
  [nzTitle]="bit.l['confirm']"
  [nzOkDisabled]="!moveForm ? false : !moveForm.valid"
  (nzOnOk)="submitMove()"
  (nzOnCancel)="closeMoveModal()"
>
  <ng-container *nzModalContent>
    <form *ngIf="moveData" nz-form nzLayout="vertical" [formGroup]="moveForm">
      <nz-form-item>
        <nz-form-label nzRequired>
          <span [innerHTML]="bit.l['moveLabel'] | Print: [moveData.length]"></span>
        </nz-form-label>
        <nz-form-control [nzErrorTip]="type.ref" [nzExtra]="typeExtra">
          <nz-select
            nzShowSearch
            formControlName="type_id"
            [nzPlaceHolder]="bit.l['movePlaceholder']"
          >
            <nz-option [nzValue]="0" [nzLabel]="bit.l['unknownType']"></nz-option>
            <ng-container *ngFor="let x of typeLists">
              <nz-option [nzValue]="x.id" [nzLabel]="x.name"></nz-option>
            </ng-container>
          </nz-select>
          <bit-error-tip
            #type
            [hasError]="{
              required: bit.l['typeRequire']
            }"
          ></bit-error-tip>
        </nz-form-control>
        <ng-template #typeExtra>
          <nz-list style="margin-top: 0.5em" nzSize="small">
            <nz-list-item *ngFor="let item of moveData">- {{ item.name }}</nz-list-item>
          </nz-list>
        </ng-template>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<nz-modal
  #deleteModal
  [nzOkText]="bit.l['deleteYes']"
  [nzOkDanger]="true"
  [nzCancelText]="bit.l['deleteCancel']"
  (nzOnOk)="submitDelete()"
  (nzOnCancel)="closeDeleteModal()"
>
  <ng-container *nzModalContent>
    <ng-container *ngIf="deleteData">
      <p [innerHTML]="bit.l['deleteLabel'] | Print: [deleteData.length]"></p>
      <nz-list nzSize="small">
        <nz-list-item *ngFor="let item of deleteData">- {{ item.name }}</nz-list-item>
      </nz-list>
    </ng-container>
  </ng-container>
</nz-modal>
