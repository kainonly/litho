<bit-header>
  <nz-alert bitBanner nzBanner nzType="info" nzCloseable [nzMessage]="nzMessage.ref">
    <bit-print #nzMessage [text]="bit.l['info']" [vars]="[vars0,vars1,vars2]">
      <ng-template #vars0>
        <nz-tag>
          <i nz-icon nzType="flag"></i>
        </nz-tag>
      </ng-template>
      <ng-template #vars1>
        <nz-tag>
          <i nz-icon nzType="file-done"></i>
        </nz-tag>
      </ng-template>
      <ng-template #vars2>
        <nz-tag>
          <i nz-icon nzType="control"></i>
        </nz-tag>
      </ng-template>
    </bit-print>
  </nz-alert>
  <button nz-button nzType="primary" [bitOpen]="['resource-add']">
    <span>{{ bit.l["add"] }}</span>
  </button>
</bit-header>

<ng-template #title>
  <nz-space>
    <nz-space-item>
      <nz-button-group>
        <button nz-button [nz-tooltip]="bit.l['close']" (click)="setExpand(false)">
          <i nz-icon nzType="node-collapse"></i>
        </button>
        <button nz-button [nz-tooltip]="bit.l['expand']" (click)="setExpand(true)">
          <i nz-icon nzType="node-expand"></i>
        </button>
      </nz-button-group>
    </nz-space-item>
    <nz-space-item>
      <nz-input-group [nzSuffix]="suffixIcon" style="width: 320px">
        <input type="text" nz-input [placeholder]="bit.l['search']" [(ngModel)]="search" />
      </nz-input-group>
      <ng-template #suffixIcon>
        <i nz-icon nzType="search"></i>
      </ng-template>
    </nz-space-item>
    <ng-container *ngIf="!isSort">
      <nz-space-item>
        <button nz-button nzType="primary" (click)="openSort()">
          <i nz-icon nzType="sort-ascending"></i>
          {{ bit.l["sort"] }}
        </button>
      </nz-space-item>
    </ng-container>
    <ng-container *ngIf="isSort">
      <nz-space-item>
        <button nz-button (click)="closeSort()">
          <i nz-icon nzType="close"></i>
          {{ bit.l["sortCancel"] }}
        </button>
      </nz-space-item>
      <nz-space-item>
        <button nz-button nzType="primary" (click)="sortSubmit()">
          <i nz-icon nzType="check"></i>
          {{ bit.l["sortYes"] }}
        </button>
      </nz-space-item>
    </ng-container>
  </nz-space>
</ng-template>

<nz-ribbon [nzText]="isSort?bit.l['isSort']:null">
  <nz-card [nzTitle]="title">
    <nz-tree
      *ngIf="isSort"
      #nzTree
      class="tree-edit"
      [nzData]="resource"
      [nzBlockNode]="true"
      [nzShowIcon]="true"
      [nzExpandAll]="true"
      [nzDraggable]="true"
      [nzBeforeDrop]="beforeDrop"
      (nzOnDragEnd)="dragEnd()"
    >
    </nz-tree>

    <nz-tree
      *ngIf="!isSort"
      #nzTree
      [nzData]="resource"
      [nzShowLine]="true"
      [nzBlockNode]="true"
      [nzExpandedIcon]="nzExpandedIcon"
      (nzExpandChange)="onExpanded()"
      (nzContextMenu)="actions($event, actionsMenu)"
      [nzTreeTemplate]="nzTreeTemplate"
      [nzSearchValue]="search"
    >
    </nz-tree>
    <ng-template #nzExpandedIcon let-node>
      <ng-container *ngIf="node.isLeaf">
        <i nz-icon nzType="file"></i>
      </ng-container>
      <ng-container *ngIf="!node.isLeaf">
        <i nz-icon [nzType]="node.isExpanded ? 'folder-open' : 'folder'"></i>
      </ng-container>
    </ng-template>
    <ng-template #nzTreeTemplate let-node>
      <nz-space>
        <nz-space-item class="title">
          <ng-container *ngIf="node.origin.icon">
            <i nz-icon [nzType]="node.origin.icon"></i>
          </ng-container>
          <mark *ngIf="node.isMatched">{{ node.title }} [ {{ node.key }} ]</mark>
          <span *ngIf="!node.isMatched">{{ node.title }} [ {{ node.key }} ]</span>
        </nz-space-item>
        <nz-space-item *ngIf="node.origin.nav || node.origin.router || node.origin.policy">
          <nz-tag>
            <ng-container *ngIf="node.origin.nav">
              <i nz-icon nzType="flag"></i>
            </ng-container>
            <ng-container *ngIf="node.origin.nav && node.origin.router">
              <nz-divider nzType="vertical"></nz-divider>
            </ng-container>
            <ng-container *ngIf="node.origin.router">
              <i nz-icon nzType="file-done"></i>
            </ng-container>
            <ng-container *ngIf="node.origin.router && node.origin.policy">
              <nz-divider nzType="vertical"></nz-divider>
            </ng-container>
            <ng-container *ngIf="node.origin.policy">
              <i nz-icon nzType="control"></i>
            </ng-container>
          </nz-tag>
        </nz-space-item>
      </nz-space>
    </ng-template>
    <nz-dropdown-menu #actionsMenu>
      <ul nz-menu *ngIf="activeNode">
        <li style="color: #333" nz-menu-item nzDisabled>
          {{ activeNode.title }} [ {{ activeNode.key }} ]
        </li>
        <li nz-menu-divider></li>
        <li nz-menu-item [bitOpen]="['resource-add', { parentId: activeNode.origin.id }]">
          <i nz-icon nzType="subnode"></i> {{ bit.l["add"] }}
        </li>
        <li *ngIf="activeNode.origin.policy" nz-menu-item (click)="openPolicy()">
          <i nz-icon nzType="function"></i> {{ bit.l["policy"] }}
        </li>
        <li nz-menu-item [bitOpen]="['resource-edit', activeNode.origin.id]">
          <i nz-icon nzType="edit"></i> {{ bit.l["edit"] }}
        </li>
        <li nz-menu-divider></li>
        <li
          nz-menu-item
          [nzDisabled]="activeNode.getChildren().length !== 0"
          (click)="delete()"
        >
          <i nz-icon nzType="delete"></i> {{ bit.l["delete"] }}
        </li>
      </ul>
    </nz-dropdown-menu>
  </nz-card>
</nz-ribbon>
<nz-drawer
  [nzWidth]="500"
  [nzTitle]="nzTitle"
  [nzVisible]="policyVisable"
  (nzOnClose)="closePolicy()"
>
  <ng-template #nzTitle>
    <b *ngIf="activeNode">{{ bit.l["policyEdit"] }}: {{ activeNode.title }}</b>
  </ng-template>
  <ng-container *nzDrawerContent>
    <ng-container *ngIf="activeNode && policyForm">
      <form nz-form [formGroup]="policyForm" (bitFormSubmit)="submitPolicy($event)">
        <ng-container *ngFor="let x of policy.get(activeNode.key)">
          <nz-tag [nzColor]="'blue'" nzMode="closeable" (nzOnClose)="deletePolicy(x.id)">
            {{ x.acl_key }}:{{ bit.l[policyInfo[x.policy]] }}
          </nz-tag>
        </ng-container>

        <nz-divider></nz-divider>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>
            {{ bit.l["resource_key"] }}
          </nz-form-label>
          <nz-form-control [nzSpan]="18">
            <input type="text" nz-input [disabled]="true" [value]="activeNode.key" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>
            {{ bit.l["acl_key"] }}
          </nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select
              formControlName="acl_key"
              nzAllowClear
              [nzShowSearch]="true"
              [nzPlaceHolder]="bit.l['aclPlaceHolder']"
            >
              <ng-container *ngFor="let x of aclLists">
                <nz-option
                  [nzLabel]="(x.name | object: bit.locale) + '[' + x.key + ']'"
                  [nzDisabled]="disabledAcl(x.key)"
                  [nzValue]="x.key"
                >
                </nz-option>
              </ng-container>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>
            {{ bit.l["policy"] }}
          </nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-radio-group formControlName="policy">
              <label nz-radio-button [nzValue]="0">{{ bit.l["readonly"] }}</label>
              <label nz-radio-button [nzValue]="1">{{ bit.l["readandwrite"] }}</label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>

        <nz-divider></nz-divider>

        <nz-form-item>
          <nz-form-control [nzOffset]="6" [nzSpan]="18">
            <button nz-button nzType="primary" [disabled]="!policyForm.valid">
              {{ bit.l["submit"] }}
            </button>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </ng-container>
</nz-drawer>
