<form *ngIf="form" nz-form nzLayout="vertical" id="form" [formGroup]="form" (wpxSubmit)="submit($event)">
  <nz-tabset style="height: 100%" nzTabPosition="left" [(nzSelectedIndex)]="tabIndex">
    <nz-tab nzTitle="字段类型">
      <nz-card [nzBodyStyle]="{ 'padding.px': 1 }">
        <nz-radio-group formControlName="type">
          <ng-container *ngFor="let item of typeItems">
            <div nz-card-grid style="text-align: center; width: 25%" [nzHoverable]="false">
              <label nz-radio [nzValue]="item.value">
                <h2><span nz-icon [nzType]="item.icon" nzTheme="outline"></span> {{ item.label }} </h2>
                <span>{{ item.description }}</span>
              </label>
            </div>
          </ng-container>
        </nz-radio-group>
      </nz-card>
    </nz-tab>
    <nz-tab nzTitle="基本设置">
      <nz-row [nzGutter]="24">
        <nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>显示名称</nz-form-label>
            <nz-form-control
              nzHasFeedback
              [nzAutoTips]="{
                default: {
                  required: '显示名称不能为空'
                }
              }"
            >
              <input nz-input type="text" formControlName="name" placeholder="显示名称，如订单号" />
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label>占位提示</nz-form-label>
            <nz-form-control nzHasFeedback>
              <input nz-input type="text" formControlName="placeholder" placeholder="输入框内提示信息" />
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label>描述</nz-form-label>
            <nz-form-control>
              <textarea nz-input formControlName="name" [rows]="3" placeholder="输入框外附加描述"></textarea>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
        <nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>字段命名</nz-form-label>
            <nz-form-control
              nzHasFeedback
              [nzAutoTips]="{
                default: {
                  required: '字段命名不能为空',
                  pattern: '请使用小写字母与下划线的组合',
                  duplicated: '字段必须是唯一的'
                }
              }"
            >
              <input nz-input type="text" formControlName="key" placeholder="数据库集合字段，如 order_number" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>必须</nz-form-label>
            <nz-form-control nzExtra="在创建内容时，此段是必需填写的">
              <nz-switch formControlName="required"></nz-switch>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label nzRequired>显示</nz-form-label>
            <nz-form-control nzExtra="表单中不显示，但可通过触发显隐规则显示">
              <nz-switch formControlName="visible"></nz-switch>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </nz-tab>
    <nz-tab nzTitle="高级设置">
      <nz-row [nzGutter]="24">
        <nz-col *ngIf="option" [nzSpan]="12">
          <ng-container formGroupName="option" [ngSwitch]="type.value">
            <ng-container *ngSwitchCase="'number'">
              <nz-form-item>
                <nz-form-label>最小值</nz-form-label>
                <nz-form-control>
                  <nz-input-number
                    style="width: 100%"
                    formControlName="min"
                    [nzStep]="1"
                    [nzPrecision]="0"
                    nzPlaceHolder="最小值，如 1"
                  ></nz-input-number>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>最大值</nz-form-label>
                <nz-form-control>
                  <nz-input-number
                    style="width: 100%"
                    formControlName="max"
                    [nzStep]="1"
                    [nzPrecision]="0"
                    nzPlaceHolder="最大值，如 1000"
                  ></nz-input-number>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label>保留小数</nz-form-label>
                <nz-form-control>
                  <nz-input-number
                    style="width: 100%"
                    formControlName="decimal"
                    [nzStep]="1"
                    [nzPrecision]="0"
                  ></nz-input-number>
                </nz-form-control>
              </nz-form-item>
            </ng-container>
            <ng-container *ngSwitchCase="'date'">
              <nz-form-item>
                <nz-form-label>包含时间</nz-form-label>
                <nz-form-control>
                  <nz-switch formControlName="time"></nz-switch>
                </nz-form-control>
              </nz-form-item>
            </ng-container>
            <ng-container *ngSwitchCase="'dates'">
              <nz-form-item>
                <nz-form-label>包含时间</nz-form-label>
                <nz-form-control>
                  <nz-switch formControlName="time"></nz-switch>
                </nz-form-control>
              </nz-form-item>
            </ng-container>
            <ng-template #enumsRef>
              <nz-form-item>
                <nz-form-label>列举元素</nz-form-label>
                <nz-form-control formArrayName="enums">
                  <ng-container *ngFor="let x of optionEnums.controls; index as i; first as isFirst">
                    <nz-input-group [formGroupName]="i" nzCompact [ngStyle]="{ 'margin-top': isFirst ? null : '-1px' }">
                      <input style="width: 45%" type="text" nz-input formControlName="label" placeholder="元素名称" />
                      <input style="width: 45%" type="text" nz-input formControlName="value" placeholder="元素值" />
                      <button style="width: 10%" nz-button type="button" nzType="default" (click)="removeOptionEnum(i)">
                        <i nz-icon nzType="minus-circle"></i>
                      </button>
                    </nz-input-group>
                  </ng-container>
                  <button
                    style="margin-top: 8px"
                    type="button"
                    nz-button
                    nzType="dashed"
                    nzBlock
                    (click)="addOptionEnum()"
                  >
                    <i nz-icon nzType="plus-circle"></i> 新增元素
                  </button>
                </nz-form-control>
              </nz-form-item>
            </ng-template>
            <ng-container *ngSwitchCase="'radio'">
              <ng-container *ngTemplateOutlet="enumsRef"></ng-container>
            </ng-container>
            <ng-container *ngSwitchCase="'checkbox'">
              <ng-container *ngTemplateOutlet="enumsRef"></ng-container>
            </ng-container>
            <ng-container *ngSwitchCase="'select'">
              <nz-form-item>
                <nz-form-label>支持多选</nz-form-label>
                <nz-form-control>
                  <nz-switch formControlName="multiple"></nz-switch>
                </nz-form-control>
              </nz-form-item>
              <ng-container *ngTemplateOutlet="enumsRef"></ng-container>
            </ng-container>
            <ng-container *ngSwitchCase="'ref'">
              <nz-form-item>
                <nz-form-label>支持多选</nz-form-label>
                <nz-form-control>
                  <nz-switch formControlName="multiple"></nz-switch>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label nzRequired>引用集合</nz-form-label>
                <nz-form-control>
                  <nz-select formControlName="ref" nzPlaceHolder="请选择引用集合">
                    <ng-container *ngFor="let x of refers">
                      <nz-option [nzValue]="x._id" [nzLabel]="x.name + ' [' + x.schema!.key + ']'"> </nz-option>
                    </ng-container>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label nzRequired>显示字段</nz-form-label>
                <nz-form-control>
                  <nz-select formControlName="ref_key" nzPlaceHolder="请选择引用字段">
                    <ng-container *ngFor="let x of referFields">
                      <nz-option [nzValue]="x.key" [nzLabel]="x.name + ' [' + x.key + ']'"> </nz-option>
                    </ng-container>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </ng-container>
            <ng-container *ngSwitchCase="'manual'">
              <nz-form-item>
                <nz-form-label nzRequired>组件标识</nz-form-label>
                <nz-form-control
                  nzHasFeedback
                  [nzAutoTips]="{
                    default: {
                      required: '组件标识不能为空'
                    }
                  }"
                >
                  <input nz-input type="text" formControlName="component" placeholder="请输入自定义组件 ID" />
                </nz-form-control>
              </nz-form-item>
            </ng-container>
          </ng-container>
        </nz-col>
        <nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>默认值</nz-form-label>
            <nz-form-control nzHasFeedback>
              <ng-container [ngSwitch]="type.value">
                <ng-container *ngSwitchCase="'string'">
                  <input nz-input type="text" formControlName="default_to" placeholder="请输入默认值" />
                </ng-container>
                <ng-container *ngSwitchCase="'text'">
                  <textarea rows="3" nz-input formControlName="default_to" placeholder="请输入默认值"></textarea>
                </ng-container>
                <ng-container *ngSwitchCase="'number'">
                  <nz-input-number
                    style="width: 100%"
                    formControlName="default_to"
                    nzPlaceHolder="请输入默认数字"
                    [nzStep]="1"
                    [nzMax]="!optionMax.value ? infinity : optionMax.value"
                    [nzMin]="!optionMin.value ? -infinity : optionMin.value"
                    [nzPrecision]="optionDecimal.value"
                  ></nz-input-number>
                </ng-container>
                <ng-container *ngSwitchCase="'date'">
                  <nz-date-picker
                    style="width: 100%"
                    formControlName="default_to"
                    nzPlaceHolder="请选择默认日期"
                    [nzShowTime]="optionTime.value"
                  ></nz-date-picker>
                </ng-container>
                <ng-container *ngSwitchCase="'dates'">
                  <nz-range-picker
                    style="width: 100%"
                    formControlName="default_to"
                    [nzShowTime]="optionTime.value"
                  ></nz-range-picker>
                </ng-container>
                <ng-container *ngSwitchCase="'bool'">
                  <nz-switch formControlName="default_to"></nz-switch>
                </ng-container>
                <ng-container *ngSwitchCase="'radio'">
                  <nz-radio-group formControlName="default_to">
                    <ng-container *ngFor="let x of optionEnums.value">
                      <label nz-radio [nzValue]="x.value">{{ x.label }}</label>
                    </ng-container>
                  </nz-radio-group>
                </ng-container>
                <ng-container *ngSwitchCase="'checkbox'">
                  <wpx-checkbox formControlName="default_to" [wpxOptions]="optionEnums.value"></wpx-checkbox>
                </ng-container>
                <ng-container *ngSwitchCase="'select'">
                  <nz-select
                    formControlName="default_to"
                    [nzMode]="optionMultiple.value ? 'tags' : 'default'"
                    nzPlaceHolder="请选择默认值"
                  >
                    <ng-container *ngFor="let x of optionEnums.value">
                      <nz-option [nzLabel]="x.label" [nzValue]="x.value"></nz-option>
                    </ng-container>
                  </nz-select>
                </ng-container>
                <ng-container *ngSwitchDefault> 无法设置 </ng-container>
              </ng-container>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </nz-tab>
  </nz-tabset>
</form>

<div *nzModalFooter>
  <button nz-button type="button" nzType="default" (click)="close()">取消</button>
  <button nz-button nzType="primary" form="form" [disabled]="!form.valid">提交</button>
</div>
