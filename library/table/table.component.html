<nz-card
  class="card"
  [ngStyle]="{ height: 'calc(100% - ' + (!wpxModel.advanced() ? 0 : wpxOffset) + 'px)' }"
  [nzTitle]="wpxTitle"
  [nzExtra]="wpxExtra"
>
  <nz-table
    [nzData]="wpxModel.data()"
    [nzLoading]="wpxModel.loading()"
    [nzFrontPagination]="false"
    [nzShowPagination]="true"
    [nzShowSizeChanger]="true"
    [nzShowTotal]="totalRef"
    [nzTotal]="wpxModel.total"
    [(nzPageIndex)]="wpxModel.page"
    [(nzPageSize)]="wpxModel.pagesize"
    [nzPageSizeOptions]="[20, 50, 100, 500, 1000]"
    [nzVirtualItemSize]="wpxItemSize"
    [nzVirtualMinBufferPx]="wpxItemSize * 10"
    [nzVirtualMaxBufferPx]="wpxItemSize * 15"
    [nzScroll]="scroll()"
    (nzPageIndexChange)="wpxChange.emit()"
    (nzPageSizeChange)="wpxChange.emit()"
  >
    <thead>
      <tr [ngStyle]="{ height: wpxItemSize + 'px' }">
        <th
          nzLeft
          nzAlign="center"
          nzWidth="60px"
          [nzChecked]="wpxModel.checked"
          [nzIndeterminate]="wpxModel.indeterminate"
          (nzCheckedChange)="wpxModel.setCurrentSelections($event)"
        ></th>
        <ng-container *ngFor="let column of columns; first as isFirst">
          <th
            *ngIf="column.display"
            nz-resizable
            nzBounds="window"
            [nzDisabled]="!resizable"
            [nzPreview]="resizable"
            [nzMaxWidth]="420"
            [nzMinWidth]="100"
            [nzWidth]="column.width ?? null"
            [nzLeft]="isFirst ? '60px' : false"
            (nzResize)="resize($event, column)"
            (nzResizeEnd)="resizeEnd()"
            (contextmenu)="openManager($event, settingsMenu, column)"
          >
            <b>{{ column.title }}</b>
            <nz-resize-handle nzDirection="right" *ngIf="resizable">
              <div class="column">{{ column.width }}</div>
              <div class="resize-wrap">
                <span class="right" nz-icon nzType="more" nzTheme="outline"></span>
              </div>
            </nz-resize-handle>
          </th>
        </ng-container>
      </tr>
    </thead>
    <tbody>
      <ng-container *nz-virtual-scroll="let data">
        <tr [ngStyle]="{ height: wpxItemSize + 'px' }" (contextmenu)="openActions($event, data)">
          <td
            nzLeft
            nzAlign="center"
            [nzDisabled]="data['disabled']"
            [nzChecked]="wpxModel.selection.has(data['_id'])"
            (nzCheckedChange)="$event ? wpxModel.setSelection(data) : wpxModel.removeSelection(data['_id'])"
          ></td>
          <ng-container *ngFor="let column of columns; first as isFirst">
            <td *ngIf="column.display" [nzLeft]="isFirst ? '60px' : false" [nzEllipsis]="column.ellipsis">
              <ng-container *ngIf="column.render; else def">
                <ng-container *ngTemplateOutlet="column.render; context: setContext(data)"></ng-container>
              </ng-container>
              <ng-template #def [ngSwitch]="column.format">
                <ng-container *ngSwitchCase="'status'">
                  <ng-container *ngIf="data[column.key]; else isOff">
                    <nz-badge nzStatus="processing" nzText="启用"></nz-badge>
                  </ng-container>
                  <ng-template #isOff>
                    <nz-badge nzStatus="default" nzText="关闭"></nz-badge>
                  </ng-template>
                </ng-container>
                <ng-container *ngSwitchCase="'date'">
                  {{ data[column.key] | date: 'yyyy/MM/dd HH:mm:ss' }}
                </ng-container>
                <ng-container *ngSwitchDefault>{{ data[column.key] }}</ng-container>
              </ng-template>
            </td>
          </ng-container>
        </tr>
      </ng-container>
    </tbody>
  </nz-table>
  <ng-template #totalRef let-total>共 {{ total }} 条记录</ng-template>
</nz-card>

<nz-dropdown-menu #settingsMenu="nzDropdownMenu">
  <ul nz-menu>
    <li nz-menu-item (click)="hide(activedColumn!)"> 不显示 </li>
    <li nz-menu-item (click)="displayAll()"> 全部显示 </li>
    <li nz-menu-divider></li>
    <li nz-menu-item (click)="openSettings()"> 设置 </li>
  </ul>
</nz-dropdown-menu>

<ng-template #settingsTitleRef>
  <nz-switch nz-tooltip="自定义列宽度" [(ngModel)]="resizable" (ngModelChange)="resizableChange()">宽度</nz-switch>
</ng-template>

<ng-template #settingsExtraRef>
  <nz-space nzAlign="center">
    <button *nzSpaceItem nz-button type="button" (click)="initPreferences()">初始自定义</button>
    <button *nzSpaceItem nz-button type="button" (click)="closeSettings()">关闭</button>
  </nz-space>
</ng-template>

<ng-template #settingsContentRef>
  <nz-checkbox-wrapper
    cdkDropList
    cdkDropListOrientation="horizontal"
    style="width: 100%"
    (cdkDropListDropped)="drop($event)"
  >
    <ng-container *ngFor="let column of columns">
      <label
        style="cursor: move"
        cdkDrag
        nz-checkbox
        [(ngModel)]="column.display"
        (ngModelChange)="updatePreferences()"
      >
        <span class="drag-placeholder" *cdkDragPlaceholder>{{ column.title }}</span>
        <b>{{ column.title }}</b>
      </label>
    </ng-container>
  </nz-checkbox-wrapper>
</ng-template>
